import streamlit as st
import pandas as pd
import time
import os
from datetime import datetime

# --- ì²˜ìŒ ì„¸íŒ… ---
if 'page' not in st.session_state:
    st.session_state.page = 'intro'  # ì²˜ìŒì—ëŠ” ë“¤ì–´ê°€ê¸° ìª½ (intro í˜ì´ì§€)ìœ¼ë¡œ ì‹œì‘
if 'trust' not in st.session_state:
    st.session_state.trust = {}
if 'selected_action' not in st.session_state:
    st.session_state.selected_action = []
if 'task' not in st.session_state:
    st.session_state.task = None
if 'timer_start_time' not in st.session_state:
    st.session_state.timer_start_time = None

# --- ì¼ê±°ë¦¬ë³„ ìë£Œ (Taskë³„ ë°ì´í„°) ---
tasks = {
    'Task 1: ì‰¬ìš´ ì •ë³´ ì•Œì•„ë³´ê¸° (ë‹¨ìˆœ ì •ë³´ ì´í•´)': {
        'situation': 'ì—¬ë¦„ì²  ë°”ê¹¥ë‚˜ë“¤ì´ ì¤‘ ê¸°ìš´ì´ ë¹ ì§„ ì‚¬ëŒì„ ë³´ì•˜ìŠµë‹ˆë‹¤. (ì—¬ë¦„ì²  ì•¼ì™¸ í™œë™ ì¤‘ íƒˆì§„í•œ ì‚¬ëŒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.)',
        'timer': 30,
        'cards': {
            'ê¸‰í•œ ì†ì§ˆ ì•ˆë‚´ê¸€ (ì‘ê¸‰ ì²˜ì¹˜ ê°€ì´ë“œ)': {
                'summary': 'íƒˆìˆ˜ ê¸°ìš´ì´ ë³´ì´ë©´, ë°”ë¡œ ê·¸ëŠ˜ì§„ ê³³ìœ¼ë¡œ ì˜®ê¸°ê³  ë¬¼ì„ ë§ˆì‹œê²Œ í•´ì•¼ í•©ë‹ˆë‹¤. (íƒˆìˆ˜ ì¦ìƒì´ ë³´ì´ë©´, ì¦‰ì‹œ ê·¸ëŠ˜ì§„ ê³³ìœ¼ë¡œ ì˜®ê¸°ê³  ìˆ˜ë¶„ì„ ë³´ì¶©í•´ì•¼ í•©ë‹ˆë‹¤.)',
                'source': 'ëŒ€í•œê¸‰ì†í•™íšŒ (ëŒ€í•œì‘ê¸‰ì˜í•™íšŒ)'
            }
        },
        'question': 'íƒˆìˆ˜ í™˜ìëŠ” ê·¸ëŠ˜ë¡œ ì˜®ê¸°ê³  ë¬¼ì„ ë§ˆì‹œê²Œ í•´ì•¼ í•©ë‹ˆë‹¤. (íƒˆìˆ˜ í™˜ìëŠ” ê·¸ëŠ˜ë¡œ ì˜®ê¸°ê³  ìˆ˜ë¶„ì„ ë³´ì¶©í•´ì•¼ í•œë‹¤.)',
        'correct_answer': 'O',
        'explanation': {
            'correct': "ì˜í•˜ì…¨ìŠµë‹ˆë‹¤! íƒˆìˆ˜ í™˜ìëŠ” ì²´ì˜¨ì„ ë‚®ì¶”ê³  ë¬¼ì„ ì²œì²œíˆ ë§ˆì‹œëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. (ì •í™•í•©ë‹ˆë‹¤! íƒˆìˆ˜ í™˜ìì˜ ê²½ìš° ì²´ì˜¨ì„ ë‚®ì¶”ê³  ìˆ˜ë¶„ì„ ë³´ì¶©í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤.)",
            'incorrect': "ì•„ì‰½ìŠµë‹ˆë‹¤. íƒˆìˆ˜ í™˜ìëŠ” ë°˜ë“œì‹œ ê·¸ëŠ˜ë¡œ ì˜®ê²¨ ì²´ì˜¨ì„ ë‚®ì¶”ê³  ë¬¼ì„ ë§ˆì…”ì•¼ í•©ë‹ˆë‹¤. (í‹€ë ¸ìŠµë‹ˆë‹¤. íƒˆìˆ˜ í™˜ìëŠ” ë°˜ë“œì‹œ ê·¸ëŠ˜ë¡œ ì˜®ê²¨ ì²´ì˜¨ì„ ë‚®ì¶”ê³  ìˆ˜ë¶„ì„ ë³´ì¶©í•´ì•¼ í•©ë‹ˆë‹¤.)"
        },
        'actions': []
    },

    'Task 2: ë‹¤ë¥¸ ì •ë³´ ê°€ìš´ë° ë°”ë¥¸ ê²ƒ ì°¾ê¸° (ì •ë³´ ì¶©ëŒ íŒë‹¨)': {
        'situation': 'ê¸¸ì—ì„œ ì—´ë¡œ ì§€ì¹œ ë“¯í•œ ì‚¬ëŒì„ ë³´ì•˜ìŠµë‹ˆë‹¤. (ê¸¸ê±°ë¦¬ì—ì„œ ì‚¬ëŒì´ ì—´ì‚¬ë³‘ìœ¼ë¡œ ì˜ì‹¬ë˜ëŠ” ì¦ìƒì„ ë³´ì…ë‹ˆë‹¤.)',
        'timer': 30,
        'cards': {
            'ê¸‰í•œ ì†ì§ˆ ê³µì‹ì±… (ì‘ê¸‰ì²˜ì¹˜ ê³µì‹ ë§¤ë‰´ì–¼)': {
                'summary': 'í™˜ìë¥¼ ì‹œì›í•œ ê³³ìœ¼ë¡œ ì˜®ê¸°ê³ , ëª¸ì„ ì ì…”ì„œ ì²´ì˜¨ì„ ë‚´ë ¤ì•¼ í•©ë‹ˆë‹¤. (í™˜ìë¥¼ ì‹œì›í•œ ê³³ìœ¼ë¡œ ì˜®ê¸°ê³ , ëª¸ì„ ì ì…” ì²´ì˜¨ì„ ë‚®ì¶°ì•¼ í•©ë‹ˆë‹¤.)',
                'source': 'ê¸‰ì† ê³µì‹ ì±…ì (ì‘ê¸‰ì²˜ì¹˜ ê³µì‹ ë§¤ë‰´ì–¼)'
            },
            'ê±´ê°• ê¸€ëª¨ìŒ ì¡°ì–¸ (ê±´ê°• ë¸”ë¡œê·¸ ì¡°ì–¸)': {
                'summary': 'ë”°ëœ»í•œ ì°¨ë¥¼ ë§ˆì‹œê²Œ í•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤. (ëœ¨ê±°ìš´ ìŒë£Œ(ë”°ëœ»í•œ ì°¨)ë¥¼ ë§ˆì‹œê²Œ í•˜ë©´ íšŒë³µì— ì¢‹ë‹¤.)',
                'source': 'ê±´ê°• ê¸°ë¡ê¸€ (ê±´ê°• ë¸”ë¡œê·¸)'
            },
            'ì†Œë°©ì²­ ê¸‰ì† ì•ˆë‚´ (ì†Œë°©ì²­ ì‘ê¸‰ì²˜ì¹˜ ê°€ì´ë“œ)': {
                'summary': 'ì˜ì‹ì´ ì—†ìœ¼ë©´ ì–µì§€ë¡œ ë¬¼ì„ ë¨¹ì´ë©´ ì•ˆ ë©ë‹ˆë‹¤. (ì˜ì‹ì´ ì—†ìœ¼ë©´ ë¬¼ì„ ì–µì§€ë¡œ ë¨¹ì´ë©´ ì•ˆ ëœë‹¤.)',
                'source': 'ì†Œë°©ì²­ ì•ˆë‚´ (ì†Œë°©ì²­ ê°€ì´ë“œ)'
            }
        },
        'actions': [
            'ì‹œì›í•œ ê³³ìœ¼ë¡œ ì˜®ê¸°ê³  ì²´ì˜¨ ë‚®ì¶”ê¸°',
            'ë”°ëœ»í•œ ì°¨ë¥¼ ë§ˆì‹œê²Œ í•˜ê¸°',
            'ë¬¼ì„ ì–µì§€ë¡œ ë¨¹ì´ê¸°'
        ],
        'correct_action': 'ì‹œì›í•œ ê³³ìœ¼ë¡œ ì˜®ê¸°ê³  ì²´ì˜¨ ë‚®ì¶”ê¸°',
        'feedback': {
            'ì‹œì›í•œ ê³³ìœ¼ë¡œ ì˜®ê¸°ê³  ì²´ì˜¨ ë‚®ì¶”ê¸°': {
                'type': 'success',
                'message': 'âœ… ì˜í•˜ì…¨ìŠµë‹ˆë‹¤! ì—´ë¡œ ì§€ì¹œ ì‚¬ëŒì€ ì¦‰ì‹œ ëª¸ì„ ì‹íˆëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤. (âœ… ì •ë‹µì…ë‹ˆë‹¤! ì—´ì‚¬ë³‘ í™˜ìì˜ ê²½ìš° ì¦‰ì‹œ ì²´ì˜¨ì„ ë‚®ì¶”ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤.)'
            },
            'ë”°ëœ»í•œ ì°¨ë¥¼ ë§ˆì‹œê²Œ í•˜ê¸°': {
                'type': 'error',
                'message': 'âŒ ì•„ì‰½ìŠµë‹ˆë‹¤. ëœ¨ê±°ìš´ ìŒë£ŒëŠ” ëª¸ì„ ë” ë¥ê²Œ í•  ìˆ˜ ìˆì–´ ìœ„í—˜í•©ë‹ˆë‹¤. (âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. ëœ¨ê±°ìš´ ìŒë£ŒëŠ” ì²´ì˜¨ì„ ë” ë†’ì¼ ìˆ˜ ìˆì–´ ìœ„í—˜í•©ë‹ˆë‹¤.)'
            },
            'ë¬¼ì„ ì–µì§€ë¡œ ë¨¹ì´ê¸°': {
                'type': 'error',
                'message': 'âŒ ì•„ì‰½ìŠµë‹ˆë‹¤. ì •ì‹ ì„ ìƒì€ ì‚¬ëŒì—ê²Œ ì–µì§€ë¡œ ë¬¼ì„ ë¨¹ì´ë©´ ê¸°ë„ê°€ ë§‰í ìˆ˜ ìˆì–´ ì•„ì£¼ ìœ„í—˜í•©ë‹ˆë‹¤. (âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. ì˜ì‹ì´ ì—†ëŠ” ìƒíƒœì—ì„œ ë¬¼ì„ ì–µì§€ë¡œ ë¨¹ì´ë©´ ê¸°ë„ê°€ ë§‰í ìˆ˜ ìˆì–´ ë§¤ìš° ìœ„í—˜í•©ë‹ˆë‹¤.)'
            }
        }
    },

    'Task 3: ë³µì¡í•œ ìƒí™©ì—ì„œ ì˜¬ë°”ë¥¸ ê¸¸ ì°¾ê¸° (ë³µí•©ì  í•´ì„ê³¼ ëŒ€ì‘)': {
        'situation': 'í° ê°€ê²Œ ì•ˆì—ì„œ ì‚¬ëŒì´ ì“°ëŸ¬ì ¸ ì •ì‹ ì´ ì—†ìŠµë‹ˆë‹¤. ì£¼ë³€ì— ìë™ ì‹¬ì¥ ì¶©ê²©ê¸°(AED)ê°€ ìˆìŠµë‹ˆë‹¤. ìƒí™©ì„ ì•„ëŠ” ì‚¬ëŒì€ ì—†ìŠµë‹ˆë‹¤. (ì‡¼í•‘ëª°ì—ì„œ ì‚¬ëŒì´ ì“°ëŸ¬ì ¸ ì˜ì‹ì´ ì—†ìŠµë‹ˆë‹¤. ì£¼ë³€ì—ëŠ” AED ì¥ë¹„ê°€ ìˆê³ , ìƒí™©ì„ ì•„ëŠ” ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.)',
        'timer': 30,
        'cards': {
            'ê¸‰ì† ì•ˆë‚´ ëˆ„ë¦¬ì§‘ (ì‘ê¸‰ì˜ë£Œí¬í„¸ ì§€ì¹¨)': {
                'summary': 'ë°”ë¡œ 119ì— ì „í™”í•˜ê³  ìë™ ì‹¬ì¥ ì¶©ê²©ê¸°ë¥¼ ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤. (ì¦‰ì‹œ 119ì— ì‹ ê³ í•˜ê³  AEDë¥¼ ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤.)',
                'source': 'ê¸‰ì† ëˆ„ë¦¬ì§‘ (ì‘ê¸‰ì˜ë£Œí¬í„¸)'
            },
            'ìë™ ì‹¬ì¥ ì¶©ê²©ê¸° ì“°ëŠ” ë²• (AED ì‚¬ìš© ê°€ì´ë“œ)': {
                'summary': 'ìë™ ì‹¬ì¥ ì¶©ê²©ê¸°ëŠ” ì•ˆë‚´ ì†Œë¦¬ë¥¼ ë”°ë¼í•˜ë©´ ëˆ„êµ¬ë‚˜ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (AEDëŠ” ìŒì„± ì•ˆë‚´ë¥¼ ë”°ë¼ ì‚¬ìš©í•˜ë©´ ëˆ„êµ¬ë‚˜ ì‰½ê²Œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)',
                'source': 'ì˜ë£Œê¸°ê´€ ì•ˆë‚´ (ì˜ë£Œê¸°ê´€ ê°€ì´ë“œ)'
            },
            'ì†ë°œ ë°ìš°ê¸° ìš”ë²• (ì˜¨ì—´ ìš”ë²•)': {
                'summary': 'ì†ê³¼ ë°œì„ ë”°ëœ»í•˜ê²Œ í•˜ë©´ íšŒë³µë©ë‹ˆë‹¤. (ì†ë°œì„ ë”°ëœ»í•˜ê²Œ í•´ì£¼ë©´ ê¸ˆë°© íšŒë³µëœë‹¤.)',
                'source': 'ì§‘ì•ˆìš”ë²• ê¸°ë¡ê¸€ (ë¯¼ê°„ìš”ë²• ë¸”ë¡œê·¸)'
            },
            'ê·€ë¥¼ ì„¸ê²Œ ì¹˜ê¸° (ê·€ ìê·¹ë²•)': {
                'summary': 'ê·€ë¥¼ ì„¸ê²Œ ë•Œë¦¬ë©´ ì •ì‹ ì„ ì°¨ë¦½ë‹ˆë‹¤. (ê·€ë¥¼ ì„¸ê²Œ ë•Œë¦¬ë©´ ì •ì‹ ì´ ëŒì•„ì˜¨ë‹¤.)',
                'source': 'ë¯¸í™•ì¸ ëª¨ì„í„° (ë¯¸í™•ì¸ ì»¤ë®¤ë‹ˆí‹°)'
            },
            'ê°€ìŠ´ ìˆ¨ì‰¬ê¸° ì†ì§ˆ (ì‹¬íì†Œìƒìˆ  ì§€ì¹¨)': {
                'summary': 'ì‹¬ì¥ì´ ë©ˆì¶˜ ê²ƒ ê°™ìœ¼ë©´ ì˜ì‹ê³¼ ìˆ¨ ì‰¬ëŠ”ì§€ ë¨¼ì € í™•ì¸í•˜ê³  ê°€ìŠ´ ëˆŒëŸ¬ ìˆ¨ì‰¬ê¸°(ì‹¬íì†Œìƒìˆ )ë¥¼ í•´ì•¼ í•©ë‹ˆë‹¤. (ì‹¬ì¥ë§ˆë¹„ ì˜ì‹¬ ì‹œ, ì˜ì‹ê³¼ í˜¸í¡ì„ ë¨¼ì € í™•ì¸í•œ í›„ ì‹¬íì†Œìƒìˆ ì„ ì‹œì‘í•´ì•¼ í•œë‹¤.)',
                'source': 'ëŒ€í•œì‹¬ì¥í•™íšŒ (ëŒ€í•œì‹¬ì¥í•™íšŒ)'
            }
        },
        'actions': [
            '119ì— ì „í™”í•˜ê¸° (119ì— ì‹ ê³ í•˜ê¸°)',
            'ìë™ ì‹¬ì¥ ì¶©ê²©ê¸° ê°€ì ¸ì˜¤ê¸° (AED ê°€ì ¸ì˜¤ê¸°)',
            'ì†ë°œì„ ë”°ëœ»í•˜ê²Œ í•˜ê¸°',
            'ê·€ë¥¼ ì„¸ê²Œ ì¹˜ê¸°',
            'ì˜ì‹ê³¼ ìˆ¨ ì‰¬ê¸° í™•ì¸í•˜ê¸° (ì˜ì‹ê³¼ í˜¸í¡ í™•ì¸í•˜ê¸°)'
        ],
        'correct_actions': ['119ì— ì „í™”í•˜ê¸° (119ì— ì‹ ê³ í•˜ê¸°)', 'ìë™ ì‹¬ì¥ ì¶©ê²©ê¸° ê°€ì ¸ì˜¤ê¸° (AED ê°€ì ¸ì˜¤ê¸°)'],
        'feedback': {
            '119ì— ì „í™”í•˜ê¸° (119ì— ì‹ ê³ í•˜ê¸°)': 'âœ… ì˜í•˜ì…¨ìŠµë‹ˆë‹¤! ê¸‰í•  ë•ŒëŠ” ì „ë¬¸ê°€ ë„ì›€ì„ ë¹¨ë¦¬ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤. (âœ… ì •í™•í•œ íŒë‹¨ì…ë‹ˆë‹¤. ì‘ê¸‰ ìƒí™©ì—ì„œëŠ” ì „ë¬¸ê°€ì˜ ë„ì›€ì´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.)',
            'ìë™ ì‹¬ì¥ ì¶©ê²©ê¸° ê°€ì ¸ì˜¤ê¸° (AED ê°€ì ¸ì˜¤ê¸°)': 'âœ… ì˜í•˜ì…¨ìŠµë‹ˆë‹¤! ìë™ ì‹¬ì¥ ì¶©ê²©ê¸°ëŠ” ìƒëª…ì„ ì‚´ë¦¬ëŠ” ë° ê¼­ í•„ìš”í•©ë‹ˆë‹¤. (âœ… ì •í™•í•œ íŒë‹¨ì…ë‹ˆë‹¤. AEDëŠ” ì‹¬ì¥ë§ˆë¹„ í™˜ìì˜ ìƒì¡´ìœ¨ì„ í¬ê²Œ ë†’ì…ë‹ˆë‹¤.)',
            'ì†ë°œì„ ë”°ëœ»í•˜ê²Œ í•˜ê¸°': 'âŒ ì†ë°œì„ ë”°ëœ»í•˜ê²Œ í•˜ëŠ” ë¯¼ê°„ìš”ë²•ì€ ë„ì›€ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (âŒ íš¨ê³¼ ì—†ëŠ” ë¯¼ê°„ìš”ë²•ì…ë‹ˆë‹¤. ê·€ì¤‘í•œ ì‹œê°„ë§Œ ë‚­ë¹„í•˜ê²Œ ë©ë‹ˆë‹¤.)',
            'ê·€ë¥¼ ì„¸ê²Œ ì¹˜ê¸°': 'âŒ ë§¤ìš° ìœ„í—˜í•œ í–‰ë™ì…ë‹ˆë‹¤. ë¨¸ë¦¬ì— í° í•´ë¥¼ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (âŒ ë§¤ìš° ìœ„í—˜í•œ í–‰ë™ì…ë‹ˆë‹¤. ë‘ë¶€ ì†ìƒì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)',
            'ì˜ì‹ê³¼ ìˆ¨ ì‰¬ê¸° í™•ì¸í•˜ê¸° (ì˜ì‹ê³¼ í˜¸í¡ í™•ì¸í•˜ê¸°)': 'âš ï¸ ì¤‘ìš”í•œ ì ˆì°¨ì´ì§€ë§Œ, ìš°ì„  119ì— ì „í™”í•˜ê³  ìë™ ì‹¬ì¥ ì¶©ê²©ê¸°ë¥¼ ì¤€ë¹„í•´ì•¼ í•©ë‹ˆë‹¤. (âš ï¸ ì¤‘ìš”í•œ ì ˆì°¨ì´ì§€ë§Œ, 119 ì‹ ê³ ì™€ AED ì¤€ë¹„ê°€ ë” ì‹œê¸‰í•©ë‹ˆë‹¤.)'
        }
    }
}

# --- ë°°ìš´ ë‚´ìš© ì €ì¥í•˜ëŠ” ê³³ (ë°ì´í„° ì €ì¥ í•¨ìˆ˜ ìˆ˜ì •) ---
def save_data():
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    
    if 'saved_responses' not in st.session_state:
        st.session_state.saved_responses = []
    
    data = {
        'ë°°ìš´ ë•Œ (Timestamp)': timestamp,
        'ë°°ìš´ ì¼ (Task)': st.session_state.task,
        'ë¯¿ì€ ê¸€ë“¤ (Trust_Responses)': st.session_state.trust,
        'ê³ ë¥¸ í–‰ë™ë“¤ (Selected_Action)': st.session_state.selected_action
    }
    
    st.session_state.saved_responses.append(data)
    
    if st.session_state.page == 'feedback':
        if len(st.session_state.saved_responses) > 0:
            df = pd.DataFrame(st.session_state.saved_responses)
            csv = df.to_csv(index=False)
            st.download_button(
                label="ğŸ“¥ ë°°ìš´ ë‚´ìš© ë‚´ë ¤ë°›ê¸° (í•™ìŠµ ê¸°ë¡ ë‹¤ìš´ë¡œë“œ)",
                data=csv,
                file_name=f"emergency_responses_{timestamp}.csv",
                mime="text/csv"
            )

def show_intro():
    st.title("ğŸš‘ ê¸‰í•œ ë•Œ ì‚´ë¦¬ëŠ” ë°°ì›€í„° (ì‘ê¸‰ ìƒí™© ëŒ€ì‘ í•™ìŠµ í”„ë¡œê·¸ë¨)")
    
    st.markdown("""
    ## ê¸‰í•  ë•Œ, ë‹¹ì‹ ì´ ì‚´ë¦¬ëŠ” í˜ì´ ë©ë‹ˆë‹¤ (ì‘ê¸‰ ìƒí™©, ë‹¹ì‹ ì˜ íŒë‹¨ì´ ìƒëª…ì„ ì¢Œìš°í•©ë‹ˆë‹¤)
    
    ì´ ë°°ì›€í„°ëŠ” ê¸‰í•  ë•Œ ë¹ ë¥´ê²Œ ì˜¬ë°”ë¥¸ íŒë‹¨ì„ í•  ìˆ˜ ìˆë„ë¡ ë•ìŠµë‹ˆë‹¤. (ì´ í”„ë¡œê·¸ë¨ì€ ì‘ê¸‰ ìƒí™©ì—ì„œì˜ ì˜¬ë°”ë¥¸ ì˜ì‚¬ê²°ì • ëŠ¥ë ¥ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•œ í•™ìŠµ ë„êµ¬ì…ë‹ˆë‹¤.)
    
    ### ğŸ“ í•  ì¼
    
    1. **ë°°ìš¸ ì¼ ê³ ë¥´ê¸° (ì‘ê¸‰ ìƒí™© ê³ ë¥´ê¸°)**

       â¡ï¸ ë°°ìš°ê³  ì‹¶ì€ ìƒí™©ì„ ê³ ë¥´ì„¸ìš”.
       â¡ï¸ 'ë°°ì›€ ì‹œì‘í•˜ê¸°' ë‹¨ì¶”ë¥¼ ëˆ„ë¥´ì„¸ìš”.
    
    2. **ê¸€ ì½ê³  í–‰ë™ ê³ ë¥´ê¸° (ì •ë³´ í™•ì¸ê³¼ ëŒ€ì‘ ê²°ì •í•˜ê¸°)**

       â¡ï¸ ê¸€ì¹´ë“œë¥¼ ëˆŒëŸ¬ ë‚´ìš©ì„ ì½ì–´ë³´ì„¸ìš”.
       â¡ï¸ ë¯¿ì„ ìˆ˜ ìˆëŠ”ì§€ ìƒê°í•˜ì„¸ìš”.
       â¡ï¸ ì–´ë–»ê²Œ í–‰ë™í• ì§€ë„ í•¨ê»˜ ìƒê°í•˜ì„¸ìš”.
       â¡ï¸ 30ì´ˆ ì•ˆì— ì„ íƒì„ ë§ˆì¹˜ì„¸ìš”.
    
    3. **ëŒì•„ë³´ê¸°í•˜ê³  ë‹¤ì‹œ ë„ì „í•˜ê¸° (ê²°ê³¼ ë³´ê³  ë‹¤ì‹œ ë„ì „í•˜ê¸°)**

       â¡ï¸ ëŒë ¤ë³´ê¸°(í”¼ë“œë°±)ë¥¼ ì‚´í´ë³´ì„¸ìš”.
       â¡ï¸ ë‹¤ì‹œ ë„ì „í•˜ê±°ë‚˜ ë‹¤ë¥¸ ìƒí™©ì„ ê³ ë¥´ì„¸ìš”.
    """)
    
    st.markdown("---")
    st.markdown("### ğŸ¯ ë°°ìš¸ ì¼ ê³ ë¥´ê¸° (í•™ìŠµí•  íƒœìŠ¤í¬ ì„ íƒ)")
    
    col1, col2 = st.columns([3, 1])
    with col1:
        selected_task = st.radio(
            "ë°°ìš°ê³  ì‹¶ì€ ìƒí™©ì„ ê³ ë¥´ì„¸ìš”: (ì‘ê¸‰ ìƒí™©ì„ ì„ íƒí•˜ì„¸ìš”:)",
            list(tasks.keys()),
            format_func=lambda x: f"{x.split(':')[0]}\n{x.split(':')[1]}"
        )
    
    st.markdown("#### ì„ íƒí•œ ìƒí™©")
    st.info(tasks[selected_task]['situation'])
    
    st.markdown("---")
    col1, col2, col3 = st.columns([1,2,1])
    with col2:
        if st.button("ë°°ì›€ ì‹œì‘í•˜ê¸° ğŸ‘‰ (í•™ìŠµ ì‹œì‘í•˜ê¸° ğŸ‘‰)", use_container_width=True):
            st.session_state.task = selected_task
            st.session_state.page = 'task'
            st.session_state.timer_start_time = time.time()
            st.rerun()

    st.markdown("---")
    st.caption("Â© 2024 ê¸‰í•œ ë•Œ ì‚´ë¦¬ëŠ” ë°°ì›€í„° (ì‘ê¸‰ ìƒí™© ëŒ€ì‘ í•™ìŠµ í”„ë¡œê·¸ë¨) | ë¬¸ì˜: emergency@example.com")

def show_task():
    if st.session_state.task is None:
        st.warning("ì˜†ì— ìˆëŠ” ë©”ë‰´ì—ì„œ ë°°ìš¸ ì¼ì„ ë¨¼ì € ê³¨ë¼ì£¼ì„¸ìš”. (ì‚¬ì´ë“œë°”ì—ì„œ Taskë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.)")
        st.stop()

    st.title("ê¸€ ì½ê³  í–‰ë™ ê³ ë¥´ê¸° (ì •ë³´ íƒìƒ‰ ë° í–‰ë™ ê²°ì •)")
    
    timer_container = st.empty()
    
    st.subheader(tasks[st.session_state.task]['situation'])

    if st.session_state.task == 'Task 1: ì‰¬ìš´ ì •ë³´ ì•Œì•„ë³´ê¸° (ë‹¨ìˆœ ì •ë³´ ì´í•´)':
        for title, content in tasks[st.session_state.task]['cards'].items():
            st.markdown("### ğŸ“‹ ê¸‰í•œ ì†ì§ˆ ì •ë³´ (ì‘ê¸‰ ì²˜ì¹˜ ì •ë³´)")
            st.info(f"**{content['summary']}**")
            st.caption(f"ì¶œì²˜: {content['source']}")
        
        st.divider()
        st.markdown("### â“ ë¬¸ì œ")
        st.markdown(f"**{tasks[st.session_state.task]['question']}**")
        
        user_answer = st.radio(
            "ë‹µì„ ê³ ë¥´ì„¸ìš”: (ë‹µì„ ì„ íƒí•˜ì„¸ìš”:)",
            options=['O', 'X'],
            horizontal=True
        )
        
        if st.button("ë‹µ ì œì¶œí•˜ê¸° (ì •ë‹µ ì œì¶œ)", use_container_width=True):
            st.session_state.selected_action = [user_answer]
            st.session_state.page = 'feedback'
            st.rerun()

    else:
        cards = tasks[st.session_state.task]['cards']
        for title, content in cards.items():
            with st.expander(f"ğŸ“„ {title}"):
                st.write(f"**ìš”ì•½:** {content['summary']}")
                st.caption(f"ì¶œì²˜: {content['source']}")
                trust = st.radio(
                    f"ì´ ê¸€ì„ ë¯¿ê² ìŠµë‹ˆê¹Œ? ('{title}' ì •ë³´ë¥¼ ì‹ ë¢°í•©ë‹ˆê¹Œ?)",
                    ('ê³ ë¥´ì§€ ì•ŠìŒ (ì„ íƒí•˜ì§€ ì•ŠìŒ)', 'ë¯¿ëŠ”ë‹¤ (ì‹ ë¢°í•œë‹¤)', 'ë¯¿ì§€ ì•ŠëŠ”ë‹¤ (ì‹ ë¢°í•˜ì§€ ì•ŠëŠ”ë‹¤)'),
                    index=0,
                    key=f"trust_{title}"
                )
                st.session_state.trust[title] = trust
        
        st.divider()
        actions = tasks[st.session_state.task]['actions']
        if st.session_state.task == 'Task 3: ë³µì¡í•œ ìƒí™©ì—ì„œ ì˜¬ë°”ë¥¸ ê¸¸ ì°¾ê¸° (ë³µí•©ì  í•´ì„ê³¼ ëŒ€ì‘)':
            st.markdown("**âš ï¸ ì—¬ëŸ¬ í–‰ë™ì„ í•¨ê»˜ ê³ ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì—¬ëŸ¬ í–‰ë™ì„ ë™ì‹œì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)**")
            action = st.multiselect("ë‹¹ì‹ ì˜ ì„ íƒ:", actions)
        else:
            action = [st.radio("ë‹¹ì‹ ì˜ ì„ íƒ:", actions)]

        if st.button("ì„ íƒ ì™„ë£Œí•˜ê¸° (ì„ íƒ ì™„ë£Œ)", use_container_width=True):
            st.session_state.selected_action = action
            st.session_state.page = 'feedback'
            st.rerun()

    # íƒ€ì´ë¨¸
    total_time = tasks[st.session_state.task]['timer']
    while True:
        elapsed_time = int(time.time() - st.session_state.timer_start_time)
        remaining_time = max(0, total_time - elapsed_time)
        progress = remaining_time / total_time

        with timer_container:
            col1, col2 = st.columns([1, 4])
            with col1:
                st.markdown(
                    f"<h1 style='text-align: center; color: red; font-size: 40px;'>{remaining_time}</h1>",
                    unsafe_allow_html=True
                )
            with col2:
                st.progress(progress)

        if remaining_time <= 0:
            with timer_container:
                st.warning("ì‹œê°„ì´ ë‹¤ ëìŠµë‹ˆë‹¤! (ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!)")
                col1, col2 = st.columns(2)
                with col1:
                    if st.button("30ì´ˆ ë” ë°°ìš°ê¸° (30ì´ˆ ë” í•™ìŠµí•˜ê¸°)", use_container_width=True):
                        st.session_state.timer_start_time = time.time()
                        st.rerun()
                with col2:
                    if st.button("ì§€ê¸ˆê¹Œì§€ í•œ ê±¸ë¡œ ë„˜ì–´ê°€ê¸° (í˜„ì¬ ìƒíƒœë¡œ ì œì¶œí•˜ê¸°)", use_container_width=True):
                        st.session_state.page = 'feedback'
                        save_data()
                        st.rerun()
            break

        time.sleep(0.1)

def show_feedback():
    st.title("ê²°ê³¼ ëŒì•„ë³´ê¸° (ê²°ê³¼ í”¼ë“œë°±)")

    task = st.session_state.task
    actions = st.session_state.selected_action

    if task == 'Task 1: ì‰¬ìš´ ì •ë³´ ì•Œì•„ë³´ê¸° (ë‹¨ìˆœ ì •ë³´ ì´í•´)':
        user_answer = st.session_state.selected_action[0]
        correct_answer = tasks[task]['correct_answer']
        
        st.markdown("### ğŸ“ ë¬¸ì œ")
        st.markdown(f"**{tasks[task]['question']}**")
        
        st.markdown("### ğŸ¯ ê²°ê³¼")
        if user_answer == correct_answer:
            st.success("âœ… ë§ì•˜ìŠµë‹ˆë‹¤! (ì •ë‹µì…ë‹ˆë‹¤!)")
            st.markdown(tasks[task]['explanation']['correct'])
        else:
            st.error("âŒ í‹€ë ¸ìŠµë‹ˆë‹¤.")
            st.markdown(tasks[task]['explanation']['incorrect'])
        
        st.divider()
        st.markdown("### ğŸ’¡ ë” ì•Œê¸° (ì¶”ê°€ ì„¤ëª…)")
        st.info("""
        íƒˆìˆ˜ í™˜ìë¥¼ ë°œê²¬í–ˆì„ ë•Œ í•´ì•¼ í•  ì¼:
        1. ë°”ë¡œ ê·¸ëŠ˜ë¡œ ì˜®ê¸°ê¸°
        2. ì‹œì›í•œ ë¬¼ì„ ì²œì²œíˆ ë§ˆì‹œê²Œ í•˜ê¸°
        3. ì •ì‹ ì´ ì—†ê±°ë‚˜ ì‹¬í•˜ë©´ 119ì— ì „í™”í•˜ê¸°
        """)

    elif task == 'Task 2: ë‹¤ë¥¸ ì •ë³´ ê°€ìš´ë° ë°”ë¥¸ ê²ƒ ì°¾ê¸° (ì •ë³´ ì¶©ëŒ íŒë‹¨)':
        st.markdown("### ğŸ“‹ ì œì‹œëœ ì •ë³´ ì‚´í´ë³´ê¸° (ì œì‹œëœ ì •ë³´ ë¶„ì„)")

        st.info("""
        1. ê¸‰ì† ê³µì‹ ì±…ì (ì‘ê¸‰ì²˜ì¹˜ ê³µì‹ ë§¤ë‰´ì–¼) â€“ ë¯¿ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
           - ë”ìš´ ë‚ ì—ëŠ” ëª¸ì„ ì‹œì›í•˜ê²Œ ì‹íˆëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤.

        2. ê±´ê°• ê¸€ëª¨ìŒ ì¡°ì–¸ (ê±´ê°• ë¸”ë¡œê·¸ ì¡°ì–¸) â€“ ë¯¿ê¸° ì–´ë µìŠµë‹ˆë‹¤.
           - ë”°ëœ»í•œ ì°¨ëŠ” ì²´ì˜¨ì„ ë” ë†’ì¼ ìˆ˜ ìˆì–´ ìœ„í—˜í•©ë‹ˆë‹¤.

        3. ì†Œë°©ì²­ ê¸‰ì† ì•ˆë‚´ (ì†Œë°©ì²­ ê°€ì´ë“œ) â€“ ë¯¿ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
           - ì •ì‹ ì´ ì—†ëŠ” í™˜ìì—ê²ŒëŠ” ì ˆëŒ€ ë¬¼ì„ ì–µì§€ë¡œ ë¨¹ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.
        """)

        st.markdown("### ğŸ¯ ë‹¹ì‹ ì˜ ì„ íƒ ê²°ê³¼ (ì„ íƒ ê²°ê³¼)")
        selected_action = actions[0]
        feedback = tasks[task]['feedback'][selected_action]
        
        if feedback['type'] == 'success':
            st.success(feedback['message'])
        else:
            st.error(feedback['message'])

        st.markdown("### ğŸ’¡ ë°”ë¥¸ ëŒ€ì²˜ë²• (ì˜¬ë°”ë¥¸ ëŒ€ì²˜ ë°©ë²•)")
        st.info("""
        ì—´ë¡œ ì“°ëŸ¬ì§„ ì‚¬ëŒì„ ë³´ë©´ ì´ë ‡ê²Œ í•˜ì„¸ìš”:

        1ï¸âƒ£ ë°”ë¡œ ì‹œì›í•œ ê³³ìœ¼ë¡œ ì˜®ê¸°ì„¸ìš”.  
        2ï¸âƒ£ ì˜·ì„ ëŠìŠ¨í•˜ê²Œ í’€ì–´ì£¼ê³  ëª¸ì„ ì‹íˆì„¸ìš”.  
        3ï¸âƒ£ ì •ì‹ ì´ ìˆìœ¼ë©´ ì‹œì›í•œ ë¬¼ì„ ì²œì²œíˆ ë§ˆì‹œê²Œ í•˜ì„¸ìš”.  
        4ï¸âƒ£ ì‹¬ê°í•˜ë©´ ë°”ë¡œ 119ì— ì „í™”í•˜ì„¸ìš”.

        âš ï¸ ì£¼ì˜í•  ì :
        - ê²€ì¦ë˜ì§€ ì•Šì€ ë¯¼ê°„ìš”ë²•ì€ ë¯¿ì§€ ë§ˆì„¸ìš”.
        - ì •ì‹ ì´ ì—†ëŠ” ì‚¬ëŒì—ê²Œ ë¬¼ì„ ë¨¹ì´ì§€ ë§ˆì„¸ìš”.
        """)

    elif task == 'Task 3: ë³µì¡í•œ ìƒí™©ì—ì„œ ì˜¬ë°”ë¥¸ ê¸¸ ì°¾ê¸° (ë³µí•©ì  í•´ì„ê³¼ ëŒ€ì‘)':
        st.markdown("### ğŸ“‹ ì œì‹œëœ ì •ë³´ ì‚´í´ë³´ê¸° (ì œì‹œëœ ì •ë³´ ë¶„ì„)")

        st.info("""
        ë¯¿ì„ ìˆ˜ ìˆëŠ” ì •ë³´:
        - ê¸‰ì† ëˆ„ë¦¬ì§‘ (ì‘ê¸‰ì˜ë£Œí¬í„¸): 119ì— ì „í™”í•˜ê³  ìë™ ì‹¬ì¥ ì¶©ê²©ê¸° ê°€ì ¸ì˜¤ê¸°
        - ì˜ë£Œê¸°ê´€ ì•ˆë‚´ (ì˜ë£Œê¸°ê´€ ê°€ì´ë“œ): ìë™ ì‹¬ì¥ ì¶©ê²©ê¸°(AED) ì‚¬ìš© ë°©ë²•
        - ëŒ€í•œì‹¬ì¥í•™íšŒ: ê°€ìŠ´ ëˆŒëŸ¬ ìˆ¨ì‰¬ê¸°(ì‹¬íì†Œìƒìˆ ) ì ˆì°¨

        ë¯¿ê¸° ì–´ë ¤ìš´ ì •ë³´:
        - ì§‘ì•ˆìš”ë²• ê¸°ë¡ê¸€ (ë¯¼ê°„ìš”ë²• ë¸”ë¡œê·¸): ì†ë°œ ë”°ëœ»í•˜ê²Œ í•˜ê¸°
        - ë¯¸í™•ì¸ ëª¨ì„í„° (ë¯¸í™•ì¸ ì»¤ë®¤ë‹ˆí‹°): ê·€ë¥¼ ì„¸ê²Œ ì¹˜ê¸°
        """)

        st.markdown("### ğŸ¯ ë‹¹ì‹ ì˜ ì„ íƒ ê²°ê³¼ ë¶„ì„ (ì„ íƒ ê²°ê³¼ ë¶„ì„)")

        st.write("ë‹¹ì‹ ì´ ê³ ë¥¸ í–‰ë™:")

        for action in actions:
            if action in tasks[task]['correct_actions']:
                st.success(f"âœ… {action}: {tasks[task]['feedback'][action]}")
            else:
                if action == 'ì˜ì‹ê³¼ ìˆ¨ ì‰¬ê¸° í™•ì¸í•˜ê¸° (ì˜ì‹ê³¼ í˜¸í¡ í™•ì¸í•˜ê¸°)':
                    st.warning(f"âš ï¸ {action}: {tasks[task]['feedback'][action]}")
                else:
                    st.error(f"âŒ {action}: {tasks[task]['feedback'][action]}")

        st.markdown("### ğŸ’¡ ë°”ë¥¸ ëŒ€ì²˜ ìˆœì„œ (ì˜¬ë°”ë¥¸ ëŒ€ì²˜ ìˆœì„œ)")
        st.info("""
        1ï¸âƒ£ ë°”ë¡œ 119ì— ì „í™”í•˜ì„¸ìš”.  
        2ï¸âƒ£ ìë™ ì‹¬ì¥ ì¶©ê²©ê¸°ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”.  
        3ï¸âƒ£ ì˜ì‹ê³¼ ìˆ¨ ì‰¬ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.  
        4ï¸âƒ£ ìë™ ì‹¬ì¥ ì¶©ê²©ê¸°ì˜ ì•ˆë‚´ ì†Œë¦¬ë¥¼ ë”°ë¼ ì‚¬ìš©í•˜ì„¸ìš”.

        âš ï¸ ì£¼ì˜:
        - ê²€ì¦ë˜ì§€ ì•Šì€ ë°©ë²•ì€ í•˜ì§€ ë§ˆì„¸ìš”.
        - í™˜ìì—ê²Œ ë¬¼ë¦¬ì  ì¶©ê²©ì„ ì£¼ì§€ ë§ˆì„¸ìš”.
        """)

    st.divider()
    again = st.radio("ë‹¤ì‹œ ë„ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë‹¤ì‹œ í•™ìŠµí•˜ì‹œê² ìŠµë‹ˆê¹Œ?)", ("ì˜ˆ", "ì•„ë‹ˆì˜¤"), horizontal=True)

    if st.button("í™•ì¸"):
        if again == "ì˜ˆ":
            st.session_state.page = 'task'
            st.session_state.trust = {}
            st.session_state.selected_action = []
            st.session_state.timer_start_time = time.time()
        else:
            st.session_state.page = 'intro'
            st.session_state.trust = {}
            st.session_state.selected_action = []
            st.session_state.task = None
            st.session_state.timer_start_time = None
        st.rerun()

# --- ë©”ì¸ í˜ì´ì§€ íë¦„ ---
with st.sidebar:
    st.markdown("### ğŸ“‹ ë©”ë‰´")
    
    if st.button("ğŸ  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° (ğŸ  ì²˜ìŒìœ¼ë¡œ)", use_container_width=True):
        st.session_state.page = 'intro'
        st.session_state.trust = {}
        st.session_state.selected_action = []
        st.session_state.task = None
        st.session_state.timer_start_time = None
        st.rerun()
    
    st.markdown("---")
    
    st.markdown("### ğŸ“ í•  ì¼ ì‚´í´ë³´ê¸° (í•  ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸)")
    if st.session_state.page == 'intro':
        st.markdown("1. âœ¨ **ë°°ìš¸ ì¼ ê³ ë¥´ê¸° (ì‘ê¸‰ ìƒí™© ê³ ë¥´ê¸°)**")
        st.markdown("2. ğŸ” ê¸€ ì½ê³  í–‰ë™ ê³ ë¥´ê¸° (ì •ë³´ í™•ì¸ê³¼ ëŒ€ì‘ ê²°ì •í•˜ê¸°)")
        st.markdown("3. ğŸ“Š ëŒì•„ë³´ê¸°í•˜ê³  ë‹¤ì‹œ ë„ì „í•˜ê¸° (ê²°ê³¼ ë³´ê³  ë‹¤ì‹œ ë„ì „í•˜ê¸°)")
    elif st.session_state.page == 'task':
        st.markdown("1. âœ“ ~~ë°°ìš¸ ì¼ ê³ ë¥´ê¸°~~")
        st.markdown("2. âœ¨ **ê¸€ ì½ê³  í–‰ë™ ê³ ë¥´ê¸° (ì •ë³´ í™•ì¸ê³¼ ëŒ€ì‘ ê²°ì •í•˜ê¸°)**")
        st.markdown("3. ğŸ“Š ëŒì•„ë³´ê¸°í•˜ê³  ë‹¤ì‹œ ë„ì „í•˜ê¸°")
    elif st.session_state.page == 'feedback':
        st.markdown("1. âœ“ ~~ë°°ìš¸ ì¼ ê³ ë¥´ê¸°~~")
        st.markdown("2. âœ“ ~~ê¸€ ì½ê³  í–‰ë™ ê³ ë¥´ê¸°~~")
        st.markdown("3. âœ¨ **ëŒì•„ë³´ê¸°í•˜ê³  ë‹¤ì‹œ ë„ì „í•˜ê¸° (ê²°ê³¼ ë³´ê³  ë‹¤ì‹œ ë„ì „í•˜ê¸°)**")

    st.markdown("---")
    
    if st.session_state.page == 'task':
        st.markdown("### ğŸ“‹ ì§€ê¸ˆ ë°°ìš°ëŠ” ì¼ (í˜„ì¬ Task)")
        st.info(f"**{st.session_state.task}**")

# ë©”ì¸ í˜ì´ì§€ í‘œì‹œ
if st.session_state.page == 'intro':
    show_intro()
elif st.session_state.page == 'task':
    show_task()
elif st.session_state.page == 'feedback':
    show_feedback()